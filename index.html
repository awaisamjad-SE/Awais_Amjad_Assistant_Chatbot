<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fetch Student Meals</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; max-width:900px; margin:auto; }
    input, button { font-size: 1rem; padding: 8px; margin-right:8px; }
    table { border-collapse: collapse; width:100%; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background:#f3f3f3; }
    .muted { color: #666; font-size:0.9rem; margin-top:8px; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>Fetch Student Meals (POST)</h1>

  <div>
    <label for="studentId">Student ID:</label>
    <input id="studentId" type="text" value="1" />
    <button id="fetchBtn">Fetch meals</button>
    <button id="sampleBtn" title="Load sample response into viewer">Load sample response</button>
  </div>

  <div class="muted">
    Method: <strong>POST</strong> â€” payload is sent as JSON in the request body.
  </div>

  <div id="status" class="muted"></div>
  <div id="result"></div>

  <script>
    const baseUrl = 'https://n8n.awaisamjad.me/webhook-test/4d9d546e-220a-45ae-9c50-5f9336856494/get-meals/:studentId';

    const fetchBtn = document.getElementById('fetchBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    function showStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.className = isError ? 'error' : 'muted';
    }

    function renderTable(meals) {
      if (!meals || !meals.length) {
        resultEl.innerHTML = '<p>No meals found.</p>';
        return;
      }

      let html = '<table><thead><tr><th>Date</th><th>Food Item</th><th>Quantity</th><th>Unit Price</th><th>Total Price</th></tr></thead><tbody>';
      let grandTotal = 0;
      meals.forEach(m => {
        html += `<tr>
          <td>${escapeHtml(m.date ?? '')}</td>
          <td>${escapeHtml(m.food_item ?? '')}</td>
          <td>${escapeHtml(String(m.quantity ?? ''))}</td>
          <td>${escapeHtml(String(m.unit_price ?? ''))}</td>
          <td>${escapeHtml(String(m.total_price ?? ''))}</td>
        </tr>`;
        grandTotal += Number(m.total_price || 0);
      });
      html += `</tbody></table>`;
      html += `<p><strong>Grand total:</strong> ${grandTotal}</p>`;
      resultEl.innerHTML = html;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function fetchMeals(studentId) {
      showStatus('Fetching meals for student ' + studentId + '...');

      // Replace :studentId in URL instead of appending
      const url = baseUrl.replace(':studentId', encodeURIComponent(studentId));

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            student_id: String(studentId),
            request_type: 'fetch_meals'
          })
        });

        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);

        const data = await resp.json();

        let parsed = data;
        if (Array.isArray(data) && data[0]?.output) {
          try {
            parsed = JSON.parse(data[0].output);
          } catch (e) {
            console.warn('Failed to parse nested output JSON:', e);
          }
        }

        const meals = parsed.meals || [];
        showStatus('Fetched ' + meals.length + ' meal(s).');
        renderTable(meals);
      } catch (err) {
        console.error(err);
        showStatus('Request failed: ' + err.message, true);
        resultEl.innerHTML = `<pre>${escapeHtml(err.stack || err.message)}</pre>`;
      }
    }

    fetchBtn.addEventListener('click', () => {
      const studentId = document.getElementById('studentId').value.trim() || '1';
      fetchMeals(studentId);
    });

    sampleBtn.addEventListener('click', () => {
      const sample = [
        {
          "output": "{\"student_id\": \"1\", \"request_type\": \"fetch_meals\", \"meals\": [{\"food_item\": \"Chicken Curry\", \"quantity\": 2, \"unit_price\": 150, \"total_price\": 300, \"date\": \"2025-10-01\"}, {\"food_item\": \"Salad\", \"quantity\": 3, \"unit_price\": 30, \"total_price\": 90, \"date\": \"2025-10-01\"}, {\"food_item\": \"Chicken Curry\", \"quantity\": 1, \"unit_price\": 150, \"total_price\": 150, \"date\": \"2025-09-29\"}]}" 
        }
      ];
      try {
        const nested = JSON.parse(sample[0].output);
        renderTable(nested.meals || []);
        showStatus('Loaded sample response: ' + (nested.meals ? nested.meals.length : 0) + ' meals.');
      } catch (e) {
        showStatus('Failed to parse sample response: ' + e.message, true);
      }
    });
  </script>
</body>
</html>
