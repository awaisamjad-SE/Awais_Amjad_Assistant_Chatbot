<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Awais Amjad Assistant</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'chat-blue': '#0084ff',
            'chat-gray': '#f3f4f6',
            'chat-dark': '#1f2937'
          },
          animation: {
            'typing': 'typing 1.5s steps(40, end) infinite',
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            typing: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.5' }
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    }
  </script>
  <!-- Custom Styles -->
  <style>
    .typing-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
    .typing-indicator:nth-child(3) { animation-delay: 0s; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
  <!-- Chat Container -->
  <div class="w-full max-w-md h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
    
    <!-- Chat Header -->
    <div class="bg-gradient-to-r from-chat-blue to-blue-600 px-6 py-4 text-white">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold">Awais Amjad Assistant</h1>
          <p class="text-blue-100 text-sm">Powered by N8N</p>
        </div>
        <div class="ml-auto">
          <div id="connection-status" class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span class="text-xs">Online</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Container -->
    <div id="messages" class="flex-1 px-4 py-6 overflow-y-auto space-y-4 bg-gray-50">
      <!-- Welcome Message -->
      <div class="flex items-start space-x-3 animate-fade-in">
        <div class="w-8 h-8 bg-gradient-to-r from-chat-blue to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm max-w-xs">
          <p class="text-gray-800 text-sm">Assalam-o-Alikum! I'm Awais Amjad Assistant. How can I help you today?</p>
          <span class="text-xs text-gray-500 mt-1 block">Just now</span>
        </div>
      </div>
    </div>

    <!-- Typing Indicator (Hidden by default) -->
    <div id="typing-indicator" class="px-4 hidden">
      <div class="flex items-start space-x-3">
        <div class="w-8 h-8 bg-gradient-to-r from-chat-blue to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
          <div class="flex space-x-1">
            <div class="typing-indicator"></div>
            <div class="typing-indicator"></div>
            <div class="typing-indicator"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-gray-200 px-4 py-4">
      <div class="flex items-center space-x-3">
        <div class="flex-1 relative">
          <input 
            type="text" 
            id="userInput" 
            placeholder="Type your message..." 
            class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-chat-blue focus:border-transparent text-sm transition-all duration-200"
            maxlength="500"
          />
          <div id="char-counter" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 hidden">
            0/500
          </div>
        </div>
        <button 
          id="sendBtn" 
          class="bg-gradient-to-r from-chat-blue to-blue-600 text-white p-3 rounded-full hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95"
          disabled
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
          </svg>
        </button>
      </div>
      
      <!-- Quick Actions -->
      <div class="flex flex-wrap gap-2 mt-3">
        <button class="quick-action px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-colors duration-200">
          üëã Hello
        </button>
        <button class="quick-action px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-colors duration-200">
          ‚ùì Help
        </button>
        <button class="quick-action px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-colors duration-200">
          Client ü§ù
        </button>
        <button class="quick-action px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-colors duration-200">
          HR ü§ù
        </button>         
      </div>
    </div>
  </div>

  <!-- Enhanced JavaScript -->
  <script>
    class ChatBot {
      constructor() {
        this.messagesDiv = document.getElementById("messages");
        this.input = document.getElementById("userInput");
        this.sendBtn = document.getElementById("sendBtn");
        this.typingIndicator = document.getElementById("typing-indicator");
        this.connectionStatus = document.getElementById("connection-status");
        this.charCounter = document.getElementById("char-counter");
        
        // N8N Configuration
        this.n8nWebhookUrl = "https://n8n.awaisamjad.me/webhook/ai-agent";
        this.isConnected = true;
        
        console.log("N8N Endpoint:", this.n8nWebhookUrl);
        console.log("Note: If you get empty responses, make sure your N8N workflow has a 'Respond to Webhook' node that returns JSON data.");
        
        this.initializeEventListeners();
        this.checkConnection();
      }

      initializeEventListeners() {
        // Send button click
        this.sendBtn.addEventListener("click", () => this.sendMessage());
        
        // Enter key press
        this.input.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Input validation and character counter
        this.input.addEventListener("input", (e) => {
          const length = e.target.value.length;
          const isEmpty = length === 0;
          
          this.sendBtn.disabled = isEmpty;
          this.sendBtn.classList.toggle("opacity-50", isEmpty);
          
          if (length > 400) {
            this.charCounter.textContent = `${length}/500`;
            this.charCounter.classList.remove("hidden");
            this.charCounter.classList.toggle("text-red-500", length > 450);
          } else {
            this.charCounter.classList.add("hidden");
          }
        });

        // Quick actions
        document.querySelectorAll(".quick-action").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const text = e.target.textContent.trim();
            this.input.value = text;
            this.input.focus();
            this.sendBtn.disabled = false;
            this.sendBtn.classList.remove("opacity-50");
          });
        });
      }

      async checkConnection() {
        try {
          const userId = this.getUserId();
          const url = `${this.n8nWebhookUrl}?message=Hello&userId=${userId}`;
          const response = await fetch(url);
          
          console.log("Health check response status:", response.status);
          this.updateConnectionStatus(response.ok);
        } catch (error) {
          console.error("Health check failed:", error);
          this.updateConnectionStatus(false);
        }
      }

      updateConnectionStatus(isOnline) {
        this.isConnected = isOnline;
        const statusDot = this.connectionStatus.querySelector("div");
        const statusText = this.connectionStatus.querySelector("span");
        
        if (isOnline) {
          statusDot.className = "w-2 h-2 bg-green-400 rounded-full animate-pulse";
          statusText.textContent = "Online";
        } else {
          statusDot.className = "w-2 h-2 bg-red-400 rounded-full";
          statusText.textContent = "Offline";
        }
      }

      addMessage(text, sender, timestamp = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex items-start space-x-3 animate-slide-up ${sender === "user" ? "flex-row-reverse space-x-reverse" : ""}`;
        
        const time = timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        if (sender === "user") {
          messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-r from-gray-500 to-gray-600 rounded-full flex items-center justify-center flex-shrink-0">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="bg-gradient-to-r from-chat-blue to-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-3 shadow-sm max-w-xs">
              <p class="text-sm">${this.escapeHtml(text)}</p>
              <span class="text-xs text-blue-100 mt-1 block">${time}</span>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-r from-chat-blue to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm max-w-xs">
              <div class="text-gray-800 text-sm">${this.formatBotMessage(text)}</div>
              <span class="text-xs text-gray-500 mt-1 block">${time}</span>
            </div>
          `;
        }
        
        this.messagesDiv.appendChild(messageDiv);
        // Only scroll to bottom for user messages, keep bot messages at top
        if (sender === "user") {
          this.scrollToBottom();
        }
      }

      showTypingIndicator() {
        this.typingIndicator.classList.remove("hidden");
        // Don't scroll when showing typing indicator to keep messages at top
      }

      hideTypingIndicator() {
        this.typingIndicator.classList.add("hidden");
      }

      async sendMessage() {
        const text = this.input.value.trim();
        if (!text) return;

        console.log("Sending message:", text); // Debug log

        // Add user message
        this.addMessage(text, "user");
        this.input.value = "";
        this.sendBtn.disabled = true;
        this.sendBtn.classList.add("opacity-50");
        this.charCounter.classList.add("hidden");

        // Show typing indicator
        this.showTypingIndicator();

        try {
          // Send message as GET request with userId for user-specific memory
          const userId = this.getUserId(); // From localStorage as before
          const url = `${this.n8nWebhookUrl}?message=${encodeURIComponent(text)}&userId=${userId}`;
          console.log("Sending GET request to:", url); // Debug log
          const response = await fetch(url);

          this.hideTypingIndicator();

          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers.get('content-type'));

          if (!response.ok) {
            const errorText = await response.text();
            console.log("Error response body:", errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
          }

          // Check if response has content
          const responseText = await response.text();
          console.log("Raw response:", responseText);

          let data;
          if (!responseText || responseText.trim() === '') {
            console.log("Empty response - N8N workflow executed but didn't return data");
            // Handle empty response gracefully - N8N executed successfully but returned no data
            data = { 
              output: "I received your message and processed it successfully, but I don't have a specific response for you right now. Please try asking something else!" 
            };
          } else {
            try {
              data = JSON.parse(responseText);
              console.log("Parsed response:", data);
            } catch (parseError) {
              console.error("JSON parse error:", parseError);
              console.log("Response was not valid JSON:", responseText);
              // Try to use the raw text as the response
              data = { output: responseText };
            }
          }
          let reply = "";

          // Handle response format (matching working version)
          if (Array.isArray(data) && data.length > 0 && data[0].output) {
            reply = data[0].output;
          } else if (data.output) {
            reply = data.output;
          } else if (data.reply) {
            reply = data.reply;
          } else if (data.answer) {
            reply = data.answer;
          } else if (data.message) {
            reply = data.message;
          } else if (data.response) {
            reply = data.response;
          } else {
            reply = "‚ö† No response from Awais Amjad Assistant";
          }

          this.addMessage(reply, "bot");
          this.updateConnectionStatus(true);

        } catch (error) {
          this.hideTypingIndicator();
          console.error("Error sending message:", error);
          
          let errorMessage = "I'm having trouble connecting to the server. ";
          
          if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            errorMessage += "Please check your internet connection.";
          } else if (error.message.includes('404')) {
            errorMessage += "The chat service endpoint was not found.";
          } else if (error.message.includes('500')) {
            errorMessage += "There's a server issue. Please try again later.";
          } else {
            errorMessage += "Please try again in a moment.";
          }
          
          this.addMessage(errorMessage, "bot");
          this.updateConnectionStatus(false);
        }
      }

      getUserId() {
        let userId = localStorage.getItem('chatbot_user_id');
        if (!userId) {
          userId = 'user_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('chatbot_user_id', userId);
        }
        return userId;
      }

      formatBotMessage(text) {
        // Basic formatting for Awais Amjad Assistant responses
        let formatted = this.escapeHtml(text);
        
        // Convert **bold** to <strong>
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
        
        // Convert *italic* to <em>
        formatted = formatted.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');
        
        // Convert bullet points
        formatted = formatted.replace(/^\*\s+(.+)$/gm, '<div class="ml-2">‚Ä¢ $1</div>');
        
        // Convert line breaks to <br>
        formatted = formatted.replace(/\n/g, '<br>');
        
        return formatted;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      scrollToBottom() {
        setTimeout(() => {
          this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
        }, 100);
      }
    }

    // Initialize the chatbot when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Initializing ChatBot...");
      const chatbot = new ChatBot();
      console.log("ChatBot initialized successfully");
    });
  </script>
</body>
</html>
